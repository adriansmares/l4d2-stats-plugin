name: Sync Fork

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions@github.com"

      - name: Sync from Upstream and check for changes
        id: sync
        run: |
          git remote add upstream https://github.com/Jackzmc/l4d2-stats-plugin.git
          git fetch upstream

          before_sha=$(git rev-parse master)
          echo "SHA before rebase: $before_sha"

          git checkout master
          git rebase upstream/master

          after_sha=$(git rev-parse master)
          echo "SHA after rebase: $after_sha"

          if [ "$before_sha" = "$after_sha" ]; then
            echo "No changes detected from upstream."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected. Pushing to master..."
            git push origin master --force
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Docker image build
        if: steps.sync.outputs.changed == 'true'
        run: gh workflow run docker-website.yml --ref master --repo $GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
