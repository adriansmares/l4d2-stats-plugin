name: Sync Fork

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: master
            tag: latest
          - branch: develop
            tag: develop

    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions@github.com"

      - name: Sync from Upstream and check for changes
        id: sync
        shell: bash
        run: |
          BRANCH=${{ matrix.branch }}
          git remote add upstream https://github.com/Jackzmc/l4d2-stats-plugin.git
          git fetch upstream

          before_sha=$(git rev-parse HEAD)
          echo "SHA of $BRANCH before rebase: $before_sha"

          # Rebase the current branch on top of the upstream branch
          git rebase upstream/$BRANCH

          after_sha=$(git rev-parse HEAD)
          echo "SHA of $BRANCH after rebase: $after_sha"

          if [ "$before_sha" = "$after_sha" ]; then
            echo "No changes detected from upstream for branch $BRANCH."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected for $BRANCH. Force-pushing to origin..."
            git push origin $BRANCH --force
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "sha=$after_sha" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger Docker image build
        if: steps.sync.outputs.changed == 'true'
        run: gh workflow run docker-website.yml -f tag=${{ matrix.tag }} -f commit=${{ steps.sync.outputs.sha }} --repo $GITHUB_REPOSITORY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
